FROM cern/cc7-base:latest AS rhel7

RUN yum install -y wget perl gcc make tree elfutils-libelf-devel yumdownloader pciutils-libs; 
RUN yum groupinstall -y  "Development Tools"; 
RUN mkdir -p /ko_output

<<<<<<< HEAD
<<<<<<< HEAD
ADD . /elkeid
WORKDIR /elkeid/driver
<<<<<<< HEAD
<<<<<<< HEAD
=======
ADD . /elkeid_driver
WORKDIR /elkeid_driver
>>>>>>> 707aed2 (update driver auto_build)
=======
ADD . /elkeid
WORKDIR /elkeid/driver
>>>>>>> 6fc7695 (fix docker path)
RUN bash ./batch_compile.sh
=======
RUN bash ./batch_compile.sh
RUN rm -rf /root/headers/*
>>>>>>> 388a69d (add centos elrepo)
=======

<<<<<<< HEAD
RUN export BUILD_VERSION=$(cat LKM/src/init.c | grep MODULE_VERSION | awk -F '"' '{print $2}'); export KO_NAME=$(grep "MODULE_NAME" ./LKM/Makefile | grep -m 1 ":=" | awk '{print $3}'); for each_ml_version in `curl http://mirrors.coreix.net/elrepo-archive-archive/kernel/el7/x86_64/RPMS/ | grep el7.elrepo.x86_64.rpm | grep kernel-ml-devel | sed -r 's/.*href="([^"]+).*/\1/g' | sed -r 's/kernel-ml-devel-([^"]+).el7.elrepo.x86_64.rpm/\1/g'`; do wget "http://mirrors.coreix.net/elrepo-archive-archive/kernel/el7/x86_64/RPMS/kernel-ml-devel"-$each_ml_version.el7.elrepo.x86_64.rpm; wget "http://mirrors.coreix.net/elrepo-archive-archive/kernel/el7/x86_64/RPMS/kernel-ml-tools"-$each_ml_version.el7.elrepo.x86_64.rpm; wget "http://mirrors.coreix.net/elrepo-archive-archive/kernel/el7/x86_64/RPMS/kernel-ml-tools-libs"-$each_ml_version.el7.elrepo.x86_64.rpm; yum remove -y kernel-tools kernel-lt-tools kernel-ml-tools kernel-tools-libs kernel-lt-tools-libs kernel-ml-tools-libs; rpm -ivh --force ./kernel*.rpm ;rm -f ./kernel*.rpm ;KVERSION=$each_ml_version.el7.elrepo.x86_64 make -C ./LKM clean || true ;BATCH=true KVERSION=$each_ml_version.el7.elrepo.x86_64 make -C ./LKM -j all || true ;KV=$each_ml_version.el7.elrepo.x86_64 sha256sum  ./LKM/${KO_NAME}.ko | awk '{print $1}' > /ko_output/${KO_NAME}_${BUILD_VERSION}_${KV}_amd64.sign  || true ; KV=$each_ml_version.el7.elrepo.x86_64 mv ./LKM/${KO_NAME}.ko /ko_output/${KO_NAME}_${BUILD_VERSION}_${KV}_amd64.ko || true ; KVERSION=$each_ml_version.el7.elrepo.x86_64  make -C ./LKM clean || true;  done;

<<<<<<< HEAD
RUN export BUILD_VERSION=$(cat LKM/src/init.c | grep MODULE_VERSION | awk -F '"' '{print $2}'); export KO_NAME=$(grep "MODULE_NAME" ./LKM/Makefile | grep -m 1 ":=" | awk '{print $3}'); for each_lt_version in `curl http://mirrors.coreix.net/elrepo-archive-archive/kernel/el7/x86_64/RPMS/ | grep el7.elrepo.x86_64.rpm | grep kernel-lt-devel | sed -r 's/.*href="([^"]+).*/\1/g' | sed -r 's/kernel-lt-devel-([^"]+).el7.elrepo.x86_64.rpm/\1/g'`; do wget "http://mirrors.coreix.net/elrepo-archive-archive/kernel/el7/x86_64/RPMS/kernel-lt-devel"-$each_lt_version.el7.elrepo.x86_64.rpm; wget "http://mirrors.coreix.net/elrepo-archive-archive/kernel/el7/x86_64/RPMS/kernel-lt-tools"-$each_lt_version.el7.elrepo.x86_64.rpm; wget "http://mirrors.coreix.net/elrepo-archive-archive/kernel/el7/x86_64/RPMS/kernel-lt-tools-libs"-$each_lt_version.el7.elrepo.x86_64.rpm; yum remove -y kernel-tools kernel-lt-tools kernel-ml-tools kernel-tools-libs kernel-lt-tools-libs kernel-ml-tools-libs; rpm -rvh --force ./kernel*.rpm ;rm -f ./kernel*.rpm ;KVERSION=$each_lt_version.el7.elrepo.x86_64 make -C ./LKM clean || true ;BATCH=true KVERSION=$each_lt_version.el7.elrepo.x86_64 make -C ./LKM -j all || true ;KV=$each_lt_version.el7.elrepo.x86_64 sha256sum  ./LKM/${KO_NAME}.ko | awk '{print $1}' > /ko_output/${KO_NAME}_${BUILD_VERSION}_${KV}_amd64.sign  || true ; KV=$each_lt_version.el7.elrepo.x86_64 mv ./LKM/${KO_NAME}.ko /ko_output/${KO_NAME}_${BUILD_VERSION}_${KV}_amd64.ko || true ; KVERSION=$each_lt_version.el7.elrepo.x86_64  make -C ./LKM clean || true;  done;
>>>>>>> d9a3610 (update elrepo logic)
=======
RUN export BUILD_VERSION=$(cat LKM/src/init.c | grep MODULE_VERSION | awk -F '"' '{print $2}'); export KO_NAME=$(grep "MODULE_NAME" ./LKM/Makefile | grep -m 1 ":=" | awk '{print $3}'); for each_lt_version in `curl http://mirrors.coreix.net/elrepo-archive-archive/kernel/el7/x86_64/RPMS/ | grep el7.elrepo.x86_64.rpm | grep kernel-lt-devel | sed -r 's/.*href="([^"]+).*/\1/g' | sed -r 's/kernel-lt-devel-([^"]+).el7.elrepo.x86_64.rpm/\1/g'`; do wget "http://mirrors.coreix.net/elrepo-archive-archive/kernel/el7/x86_64/RPMS/kernel-lt-devel"-$each_lt_version.el7.elrepo.x86_64.rpm; wget "http://mirrors.coreix.net/elrepo-archive-archive/kernel/el7/x86_64/RPMS/kernel-lt-tools"-$each_lt_version.el7.elrepo.x86_64.rpm; wget "http://mirrors.coreix.net/elrepo-archive-archive/kernel/el7/x86_64/RPMS/kernel-lt-tools-libs"-$each_lt_version.el7.elrepo.x86_64.rpm; yum remove -y kernel-tools kernel-lt-tools kernel-ml-tools kernel-tools-libs kernel-lt-tools-libs kernel-ml-tools-libs; rpm -ivh --force ./kernel*.rpm ;rm -f ./kernel*.rpm ;KVERSION=$each_lt_version.el7.elrepo.x86_64 make -C ./LKM clean || true ;BATCH=true KVERSION=$each_lt_version.el7.elrepo.x86_64 make -C ./LKM -j all || true ;KV=$each_lt_version.el7.elrepo.x86_64 sha256sum  ./LKM/${KO_NAME}.ko | awk '{print $1}' > /ko_output/${KO_NAME}_${BUILD_VERSION}_${KV}_amd64.sign  || true ; KV=$each_lt_version.el7.elrepo.x86_64 mv ./LKM/${KO_NAME}.ko /ko_output/${KO_NAME}_${BUILD_VERSION}_${KV}_amd64.ko || true ; KVERSION=$each_lt_version.el7.elrepo.x86_64  make -C ./LKM clean || true;  done;
>>>>>>> 993e581 (fix rpm cmd)
=======
RUN bash ./batch_compile_elrepo7.sh
>>>>>>> 55fe4fa (fix elrepo 2)
